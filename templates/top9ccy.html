<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top 9 æŒå€‰è¶¨å‹¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Roboto, sans-serif; padding-bottom: 50px; }
        .container-wide { max-width: 1600px; margin: 0 auto; padding: 20px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { background-color: white; border-bottom: 1px solid #f0f0f0; font-weight: bold; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        
        .btn-home {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            text-decoration: none;
            transition: opacity 0.3s;
        }
        .btn-home:hover { opacity: 0.9; color: white; }
    </style>
</head>
<body>

<nav class="navbar navbar-light bg-white shadow-sm mb-4">
    <div class="container-wide d-flex justify-content-between align-items-center">
        <span class="navbar-brand mb-0 h1 fw-bold">ğŸ† Top 9 æŒå€‰æ­·å²èµ°å‹¢</span>
        <!-- è¿”å›æŒ‰éˆ• -->
        <a href="/" class="btn-home">ğŸ  è¿”å›ä¸»é  (Dashboard)</a>
    </div>
</nav>

<div class="container-wide">
    <div class="row" id="chartsArea">
        <!-- é€™è£¡æœƒç”± JS è‡ªå‹•ç”Ÿæˆ 9 å€‹åœ–è¡¨ -->
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">æ­£åœ¨åˆ†ææŒå€‰æ•¸æ“š...</p>
        </div>
    </div>
</div>

<script>
    // å®šç¾© 9 ç¨®ä¸åŒçš„é¡è‰² (ç”¨æ–¼ Top 1 ~ Top 9)
    const chartColors = [
        '#FF6384', // ç´… (Top 1)
        '#36A2EB', // è— (Top 2)
        '#FFCE56', // é»ƒ (Top 3)
        '#4BC0C0', // é’ (Top 4)
        '#9966FF', // ç´« (Top 5)
        '#FF9F40', // æ©˜ (Top 6)
        '#C9CBCF', // ç° (Top 7)
        '#E7E9ED', // æ·ºç° (Top 8)
        '#764ba2'  // æ·±ç´« (Top 9)
    ];

    let charts = []; // å„²å­˜æ‰€æœ‰åœ–è¡¨å¯¦ä¾‹

    // é€šç”¨åœ–è¡¨ç¹ªè£½å‡½æ•¸ (èˆ‡ Index é‚è¼¯ä¸€è‡´)
    function createChart(canvasId, label, color, times, values) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        
        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: times,
                datasets: [{
                    label: label,
                    data: values,
                    borderColor: color,
                    backgroundColor: color + '33',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: { title: ctx => ctx[0].label }
                    }
                },
                scales: {
                    x: { 
                        display: true, 
                        grid: { display: false }, 
                        ticks: { 
                            maxRotation: 0, 
                            autoSkip: false, 
                            callback: function(val, index, values) {
                                const total = values.length;
                                const fullLabel = this.getLabelForValue(val); 
                                const dateOnly = fullLabel.split(' ')[0];

                                // é ­å°¾ + ä¸­é–“3ç­†é‚è¼¯
                                if (index === total - 1) return fullLabel;
                                if (index === 0) return dateOnly;
                                const step = (total - 1) / 4;
                                const targetIndices = [Math.round(step), Math.round(step * 2), Math.round(step * 3)];
                                if (targetIndices.includes(index)) return dateOnly;
                                return null;
                            }
                        } 
                    },
                    y: { 
                        grid: { borderDash: [5, 5] },
                        ticks: {
                            callback: function(value) {
                                if(value >= 1000) return '$' + value/1000 + 'k';
                                return '$' + value;
                            }
                        }
                    }
                },
                interaction: { intersect: false, mode: 'index' },
            }
        });
    }

    async function initTop9Dashboard() {
        try {
            // 1. ç²å– "ç¾åœ¨" çš„æŒå€‰æ’å (æ±ºå®šåœ–è¡¨é †åº)
            const resPortfolio = await fetch('/api/portfolio');
            const jsonPortfolio = await resPortfolio.json();
            
            // 2. ç²å– "æ­·å²" æ•¸æ“š (æ±ºå®šç·šæ¢èµ°å‹¢)
            const resHistory = await fetch('/api/history');
            const jsonHistory = await resHistory.json();

            if (jsonPortfolio.status !== 'success' || jsonHistory.status !== 'success') return;

            const currentData = jsonPortfolio.data; // åŒ…å« details (å·²æ’åº)
            const historyData = jsonHistory.history;
            const times = historyData.map(h => h.time);

            // æŒ‰åƒ¹å€¼å¾å¤§åˆ°å°æ’åºæ‰€æœ‰æŒå€‰
            const sortedAssets = currentData.details.sort((a, b) => b.value - a.value);
            
            // å–å‰ 9 å (ä¸è¶³ 9 å€‹å°±å–å…¨éƒ¨)
            const top9 = sortedAssets.slice(0, 9);

            // æ¸…ç©ºç•«é¢
            const container = document.getElementById('chartsArea');
            container.innerHTML = '';

            // ç”Ÿæˆ 9 å€‹åœ–è¡¨
            top9.forEach((asset, index) => {
                const coinName = asset.coin;
                const color = chartColors[index] || '#000000';
                
                // === é—œéµé‚è¼¯ï¼šå¾æ­·å²ç´€éŒ„ä¸­æŒ–å‡ºè©²å¹£ç¨®çš„æ•¸æ“š ===
                // å› ç‚ºèˆŠç´€éŒ„å¯èƒ½åªæœ‰ top1~3ï¼Œæ²’æœ‰ detailsï¼Œæ‰€ä»¥è¦åšç›¸å®¹è™•ç†
                const historyValues = historyData.map(record => {
                    // 1. å¦‚æœæœ‰æ–°ç‰ˆ 'coins' æ¬„ä½ï¼Œç›´æ¥æ‹¿
                    if (record.coins && record.coins[coinName] !== undefined) {
                        return record.coins[coinName];
                    }
                    // 2. å¦‚æœæ˜¯èˆŠç‰ˆç´€éŒ„ï¼Œæª¢æŸ¥å®ƒç•¶æ™‚æ˜¯å¦åœ¨ Top 3
                    if (record.top1_coin === coinName) return record.top1_val;
                    if (record.top2_coin === coinName) return record.top2_val;
                    if (record.top3_coin === coinName) return record.top3_val;
                    
                    // 3. çœŸçš„éƒ½æ²’æœ‰ï¼Œåªèƒ½è£œ 0 (å› ç‚ºç•¶æ™‚æ²’å­˜åˆ°)
                    return 0;
                });

                // å»ºç«‹ HTML çµæ§‹
                const colDiv = document.createElement('div');
                colDiv.className = 'col-lg-4 col-md-6 mb-4'; // 3æ¬„æˆ–2æ¬„ä½ˆå±€
                colDiv.innerHTML = `
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span style="color: ${color}">#${index + 1} ${coinName}</span>
                            <span class="text-muted small">$${asset.value.toLocaleString(undefined, {maximumFractionDigits: 0})}</span>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="chartTop${index}"></canvas>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(colDiv);

                // ç¹ªè£½åœ–è¡¨
                createChart(`chartTop${index}`, coinName, color, times, historyValues);
            });

        } catch (e) {
            console.error("Error loading Top 9:", e);
        }
    }

    // å•Ÿå‹•é é¢
    initTop9Dashboard();
    
    // è¨­å®šæ¯ 60 ç§’åˆ·æ–°ä¸€æ¬¡ (è¬ä¸€æ’åè®Šäº†ï¼Œåœ–è¡¨ä½ç½®æœƒè‡ªå‹•æ›)
    setInterval(initTop9Dashboard, 60000);

</script>

</body>
</html>